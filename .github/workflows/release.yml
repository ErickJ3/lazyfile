name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  get-version:
    runs-on: self-hosted
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Get version from tag
        id: version
        run: |
          if [[ "${GITHUB_REF}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="0.0.0-dev"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

  build-debian:
    runs-on: self-hosted
    needs: get-version

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential curl pkg-config

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build release binary
        run: |
          cargo build --release
          strip target/release/lazyfile

      - name: Create Debian package structure
        env:
          VERSION: ${{ needs.get-version.outputs.version }}
        run: |
          mkdir -p debian_package/DEBIAN
          mkdir -p debian_package/usr/local/bin
          mkdir -p debian_package/usr/share/doc/lazyfile

          cp target/release/lazyfile debian_package/usr/local/bin/
          cp README.md debian_package/usr/share/doc/lazyfile/

          cat > debian_package/DEBIAN/control << EOF
          Package: lazyfile
          Version: ${VERSION}
          Architecture: amd64
          Maintainer: Erick Jesus <erick.jesus2060@gmail.com>
          Description: Terminal UI for browsing cloud storage via rclone
           LazyFile provides a lightweight terminal user interface for interacting
           with cloud storage systems via rclone. It emphasizes simplicity,
           reliability, and developer experience.
          EOF

          cat > debian_package/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          set -e
          echo "LazyFile installed successfully!"
          echo "Start rclone RC daemon with: rclone rcd --rc-addr 127.0.0.1:5572 --rc-no-auth"
          echo "Then run: lazyfile"
          EOF
          chmod 755 debian_package/DEBIAN/postinst

      - name: Build .deb package
        env:
          VERSION: ${{ needs.get-version.outputs.version }}
        run: |
          dpkg-deb --build debian_package lazyfile_${VERSION}_amd64.deb

      - name: Upload Debian artifact
        uses: actions/upload-artifact@v4
        env:
          VERSION: ${{ needs.get-version.outputs.version }}
        with:
          name: lazyfile-debian-amd64
          path: lazyfile_${{ needs.get-version.outputs.version }}_amd64.deb

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: lazyfile_${{ needs.get-version.outputs.version }}_amd64.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-ubuntu:
    runs-on: self-hosted
    needs: get-version

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential curl pkg-config

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build release binary
        run: |
          cargo build --release
          strip target/release/lazyfile

      - name: Create archive
        env:
          VERSION: ${{ needs.get-version.outputs.version }}
        run: |
          mkdir -p lazyfile-${VERSION}-ubuntu-x86_64
          cp target/release/lazyfile lazyfile-${VERSION}-ubuntu-x86_64/
          cp README.md lazyfile-${VERSION}-ubuntu-x86_64/
          tar -czf lazyfile-${VERSION}-ubuntu-x86_64.tar.gz lazyfile-${VERSION}-ubuntu-x86_64/

      - name: Upload Ubuntu artifact
        uses: actions/upload-artifact@v4
        with:
          name: lazyfile-ubuntu-x86_64
          path: lazyfile-${{ needs.get-version.outputs.version }}-ubuntu-x86_64.tar.gz

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: lazyfile-${{ needs.get-version.outputs.version }}-ubuntu-x86_64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux-generic:
    runs-on: self-hosted
    needs: get-version

    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential curl pkg-config

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build release binary (static)
        run: |
          cargo build --release
          strip target/release/lazyfile

      - name: Create generic Linux archive
        env:
          VERSION: ${{ needs.get-version.outputs.version }}
        run: |
          mkdir -p lazyfile-${VERSION}-linux-x86_64
          cp target/release/lazyfile lazyfile-${VERSION}-linux-x86_64/
          cp README.md lazyfile-${VERSION}-linux-x86_64/
          tar -czf lazyfile-${VERSION}-linux-x86_64.tar.gz lazyfile-${VERSION}-linux-x86_64/

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: lazyfile-linux-x86_64
          path: lazyfile-${{ needs.get-version.outputs.version }}-linux-x86_64.tar.gz

      - name: Upload to release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: lazyfile-${{ needs.get-version.outputs.version }}-linux-x86_64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-packages:
    needs: [get-version, build-debian, build-ubuntu]
    runs-on: self-hosted

    steps:
      - name: Download Debian package
        uses: actions/download-artifact@v4
        with:
          name: lazyfile-debian-amd64

      - name: Test Debian package
        env:
          VERSION: ${{ needs.get-version.outputs.version }}
        run: |
          sudo dpkg -i lazyfile_${VERSION}_amd64.deb || sudo apt-get install -f -y
          which lazyfile
          lazyfile --help || true

      - name: Cleanup
        run: |
          sudo dpkg -r lazyfile || true         ls -la test_ubuntu/
